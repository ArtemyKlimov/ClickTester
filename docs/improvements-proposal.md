# Предложения по тестам и улучшениям ClickTester

Ниже — идеи новых тестов и доработок, которые можно внедрять по приоритету.

---

## 1. Новые тесты

### 1.1 Структурные проверки (structure_checks)

| Тип | Описание | Реализация |
|-----|----------|------------|
| **order_by** | Соответствие ORDER BY / PRIMARY KEY эталону (из `SHOW CREATE TABLE`) | Новый тип в `structureQuery()`: запрос `SHOW CREATE TABLE`, в отчёте — сырой текст или парсинг (например, проверка подстроки `ORDER BY (mainTimestampTime, appName, localTime)`). Критерий: запрос выполнен; опционально — сравнение с эталонной строкой из конфига. |
| **ttl** | Наличие и формула TTL (TRACE/DEBUG 3 дня, остальное 4 дня) | Запрос `SHOW CREATE TABLE` и проверка наличия TTL-выражения в выводе. Опционально: парсинг и сравнение с эталоном. |
| **codecs** | Наличие ожидаемых кодеков по колонкам (Delta, ZSTD) | `SELECT name, compression_codec FROM system.columns WHERE database = ? AND table = ?` — вывод в отчёт или сравнение с эталонным списком из конфига. |
| **parts_count** | Количество активных частей (parts) — индикатор необходимости OPTIMIZE | `SELECT count() FROM system.parts WHERE database = ? AND table = ? AND active`. Порог в конфиге: например, `parts_warn: 100`, отображать в отчёте. |
| **wide_parts** | Соответствие min_rows/min_bytes для wide parts | Из `system.parts` или настроек движка — тип частей (wide/compact). Опционально: сравнение с параметрами из схемы. |

### 1.2 Запросы по индексам (query_templates)

Сейчас в основном покрыты: `projectCode`, `appName`, `namespace`, `level`, `hasToken(text/stack)`. По каталогу тестов и схеме можно добавить:

| Назначение | Что проверяет | Пример запроса (идея) |
|------------|----------------|------------------------|
| **identity_idx** | Поиск по messageId / traceId / callId (bloom_filter) | `WHERE mainTimestampTime >= now() - INTERVAL 1 HOUR AND messageId = '$messageId$'` (добавить `messageId` в test_params и плейсхолдеры). |
| **eventId_idx** | Поиск по eventId / extEventId | `WHERE ... AND eventId = '$eventId$'` (или in list). |
| **attributes_*** | Поиск по mainAttributes (ключи/значения) | `WHERE ... AND mainAttributes['key'] = 'val'` или использование индекса attributes_string_idx_*. |
| **mdc_idx** | Поиск по tslgMdc (tokenbf_v1) | `WHERE ... AND hasToken(lower(tslgMdc), lower('$mdc_token$'))`. |
| **Проекция** | Использование проекции в агрегациях | Текущие agg-тесты уже проверяют агрегации; в отчёте можно помечать, если в EXPLAIN встречается упоминание projection (парсинг ExplainText). |

Добавление: новые плейсхолдеры в конфиге (`messageId`, `eventId`, `mdc_token` и т.д.) и соответствующие шаблоны в `configs/default.yaml` (или отдельный файл «расширенных» тестов).

### 1.3 Санитарные проверки

- **Проверка подключения**: перед основным прогоном выполнить `SELECT 1` или `SELECT count() FROM system.tables` и при ошибке не запускать тесты.
- **Проверка существования таблицы**: `SELECT 1 FROM $table_name$ LIMIT 1` — быстрый тест, что таблица доступна и читаема.

Их можно оформить как отдельные structure-подобные проверки или выполнять один раз в `main` до `BuildTasks`.

---

## 2. Улучшения отчёта (report)

| Улучшение | Описание |
|-----------|----------|
| **Сортировка** | Сначала строки со статусом fail, затем warn, затем ok (или настраиваемый порядок). |
| **Индикатор использования проекции** | ~~Парсить `ExplainText`: если есть подстрока `Projection` / `projection` — выводить в отдельной колонке «Projection used: yes/no».~~ **Реализовано**: колонка Projection в HTML-отчёте и в UI -serve; парсинг в chclient.ProjectionUsed. |
| **Экспорт** | ~~Флаг `-format json` или `-format csv`: тот же набор результатов в машиночитаемом виде для CI/аналитики.~~ **Реализовано**: `-format json` и `-format both`; JSON содержит meta + results с полями запроса (name, description, query) и метриками. |
| **Сводка по метрикам** | В шапке или внизу: max/avg read_rows, max/avg duration по query-тестам; количество тестов в warn/fail. |
| **Открытие в браузере** | Опция `-open` или в конфиге: после записи отчёта открыть `report.html` в браузере по умолчанию (через `exec.Command` / `start` на Windows). |

---

## 3. Улучшения конфигурации и CLI

| Улучшение | Описание |
|-----------|----------|
| **Подстановка переменных окружения** | В конфиге поддерживать значения вида `password: ${CH_PASSWORD}` или `env:CH_PASSWORD` и подставлять из `os.Getenv` при загрузке. |
| **Внешний файл query_templates** | В конфиге опция `query_templates_file: path/to/queries.yaml` — загрузка списка шаблонов из отдельного файла (удобно для больших наборов). |
| **Сухой прогон** | Флаг `-dry-run`: загрузить конфиг, построить задачи, вывести список (name, type, опционально усечённый query) без подключения к ClickHouse. |
| **Остановка при первой ошибке** | Флаг `-fail-fast`: после первого упавшего теста не запускать остальные (удобно для отладки). |
| **Вывод в формате для CI** | `-format json`: в stdout вывести RunResult в JSON (passed/failed, список ошибок) для парсинга в CI. |

---

## 4. Улучшения раннера и надёжности

| Улучшение | Описание |
|-----------|----------|
| **Повтор при временных сбоях** | Для запросов (не structure): при ошибке (например, timeout, connection reset) повторить запрос 1–2 раза с небольшой задержкой; в конфиге `retry_count`, `retry_delay_sec`. |
| **Таймаут на весь прогон** | Глобальный таймаут (например, `run_timeout_sec`): контекст с дедлайном на весь `runner.Run`, чтобы не зависать при большом числе тестов. |

---

## 5. Тестирование кода

| Улучшение | Описание |
|-----------|----------|
| **Unit-тесты buildtasks** | Тесты для `SubstituteQueryParams` (все плейсхолдеры подставляются, экранирование не ломает запрос), для `structureQuery` (все известные типы возвращают непустой SQL, неизвестный тип — ошибка). |
| **Unit-тесты chclient** | Тесты для `ExtractGranules` на разных вариантах текста EXPLAIN (разные форматы вывода CH). |
| **Интеграционные тесты** | Запуск против реального ClickHouse (Docker) или мок клиента: загрузка конфига → BuildTasks → Run с моком → проверка формата RunResult и вызова Query/Explain. |

---

## 6. Удобство разработки и деплой

| Улучшение | Описание |
|-----------|----------|
| **Makefile или скрипты** | `make build`, `make run`, `make test`, `make report` — стандартизация команд (особенно для Windows: `make` или `build.cmd`/`run.cmd`). |
| **Docker** | Dockerfile для сборки бинарника; опционально docker-compose с ClickHouse для локального прогона тестов. |
| **Пример конфига под CI** | Отдельный `configs/ci.yaml` с минимальным набором тестов и жёсткими порогами для стабильного прохода в пайплайне. |

---

## 7. Приоритизация (рекомендуемый порядок)

1. **Быстрые победы**: санитарная проверка таблицы/подключения в main; сортировка в отчёте (fail → warn → ok); флаг `-dry-run`.
2. **Полезные тесты**: structure `parts_count` с порогом; 1–2 query по identity/eventId (если в схеме есть такие колонки и индексы).
3. **Конфиг и секреты**: подстановка `${VAR}` из окружения для пароля и при необходимости других полей.
4. **CI и автоматизация**: `-format json`, пример ci.yaml; при необходимости — unit-тесты для buildtasks и ExtractGranules.
5. **По желанию**: retry, run_timeout, экспорт CSV, открытие отчёта в браузере, Docker.

Документ можно использовать как бэклог: выносить пункты в задачи и отмечать выполненное в `progress.md`.
